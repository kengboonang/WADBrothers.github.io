<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map interface testing for website</title>
    <!-- Axios -->
    <script src='https://unpkg.com/axios/dist/axios.js'></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    

    <style>
        /* 
        * Always set the map height explicitly to define the size of the div element
        * that contains the map. 
        */
        #map {
        height: 80%;
        }

        /* 
        * Optional: Makes the sample page fill the window. 
        */
        html,
        body {
        height: 100%;
        margin: 10px;
        padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="text" id="autocomplete" placeholder="Enter a place" style="width: 80%;">
        <h1 id="place_name"></h1>
        <h1 id="place_id"></h1>
        <h1 id="place_geometry">
            <h2 id="latitude"></h2>
            <h2 id="longitude"></h2>
        </h1>
    </div>
    <div id="map"></div>

    <!-- functions -->
    <script>

        // create your map
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: {lat: 37.5665, lng:126.9780},
            }
            );
            map.addListener("click", (e) => {
                placeMarkerAndPanTo(e.latLng,map);
            });
        }
        
        // create markers on click
        function placeMarkerAndPanTo(latLng, map) {
            
            const icon = {
               url:  "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
               scaledSize: new google.maps.Size(30,30),
            };
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: icon
            });

            // get place ID (the long way)
            let p_id = getPID(latLng)
            // get place details  
            let place = p_id.then(value => {
                // console.log(value)
                get_place_details(value)
            })
            // console.log(place)    
            
            // customized InfoWindow
            const contentString = 
                `
                <div id="content">
                <div id="siteNotice"></div>

                <div class="container">
                
                <div class="row">
                    <div class = "col-8">
                    <span class="badge rounded-pill text-bg-warning">#Shopping</span>
                    <h3>Hongdae Shopping Street</h3>
                    <p class="address">365-8 Seogyo-dong, Mapo-gu, Seoul, South Korea<p>
                    <hr>
                    <h6>$100/person</h6>
                    <p class="description">Description included by user.     Lorem, ipsum dolor sit amet consectetur adipisicing elit. Quod consequuntur, provident magnam nobis quis autem odit, nulla inventore cumque repudiandae facere. Nisi, itaque! Odit eos libero dolorem, reprehenderit dicta illo!</p>
                    </div>

                    <div class="col-4" style:"position:relative">
                    <p class="pt-3">Current Votes: </p>
                        <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" aria-label="voted_yes" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-danger" role="progressbar" aria-label="voted_no" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-secondary" role="progressbar" aria-label="yet_to_vote" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="voting_buttons pt-3">
                        <button type="button" class="btn btn-danger btn-sm reject_btn">Reject</button>
                        <button type="button" class="btn btn-success btn-sm vote_btn"> Vote </button>
                        </div>
                        <button type="button" class="btn btn-sm rounded bg-primary text-white float-end" style="position:absolute;bottom:25; right:25;" data-bs-toggle="button">Edit</button>
                    </div>

                </div>  
                </div>
            </div>
            </div>
                `

            const infoWindow = new google.maps.InfoWindow({
                content: contentString,
                disableAutoPan: true,
            });
            // identify the marker
            marker.id = uniqueId;
            uniqueId++;
            // allow marker to be deleted
            var label = "<br /><input type = 'button' va;ue = 'Delete' onclick = 'DeleteMarker(" + marker.id + ");' value = 'Delete' />";
            // open infoWindow :click
            marker.addListener("click", (googleMapsEvent) => {
                infoWindow.open(map, marker);
            });
            // add marker to array
            markers.push(marker)
        }

        // get place ID 2
        function getPID(latLng) {
                var geocoder = new google.maps.Geocoder;
                if (latLng !== "") {
                    return new Promise(function(resolve, reject) {
                        geocoder.geocode({'location': latLng}, function(results, status) {
                            if (status === google.maps.GeocoderStatus.OK) {
                                if (results[1]) {
                                    // console.log(results[1].place_id);
                                    resolve(results[1].place_id)
                                } else {
                                    window.alert('No results found');
                                }
                                } else {
                                window.alert('Geocoder failed due to: ' + status);
                                }
                        });
                    })
                }
            }

        // get place ID
        function get_place_id(marker,latLng) {
                var geocoder = new google.maps.Geocoder;

                latitude=marker.getPosition().lat();               
                longitude=marker.getPosition().lng();
                var latlng = {lat: parseFloat(latitude), lng: parseFloat(longitude)};
                
                geocoder.geocode({'location': latlng}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        // console.log(results[1].place_id);
                        var p_id = results[1].place_id;
                        // console.log(p_id)
                        return p_id
                    } else {
                        window.alert('No results found');
                    }
                } else {
                window.alert('Geocoder failed due to: ' + status);
                    }
                });
                }

        // get place details from place ID
        function get_place_details(p_id) {
            axios.get('https://maps.googleapis.com/maps/api/geocode/json', {
                    params: {
                        place_id:  p_id,
                        key: 'AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU'
                    }
                })
                    .then(response => {
                        console.log(response.data.results[0]);
                        var place_details = response.data.results[0]
                        return place_details
                    })
                    .catch( error => {
                        console.log(error.message);
                    });
        }
        // cached variables
        var markers = [];
        var uniqueId = 1;
        window.initMap = initMap;
    </script>

    <!-- import scripts -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU&callback=initMap&v=weekly"
      defer
    ></script>
    <!-- <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU&libraries=places&callback=initAutocomplete">
    </script> -->

</body>
</html>