<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map interface testing for website</title>
    <!-- Axios -->
    <script src='https://unpkg.com/axios/dist/axios.js'></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    

    <style>
        /* 
        * Always set the map height explicitly to define the size of the div element
        * that contains the map. 
        */
        #map {
        height: 80%;
        }

        /* 
        * Optional: Makes the sample page fill the window. 
        */
        html,
        body {
        height: 100%;
        margin: 10px;
        padding: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="text" id="autocomplete" placeholder="Enter a place" style="width: 80%;">
        
        <hr>
        <input type="button" value="Delete All Created Markers" onclick="DeleteMarkers()" />
        <h1 id="place_name"></h1>
        <h1 id="place_id"></h1>
        <h1 id="place_geometry">
            <h2 id="latitude"></h2>
            <h2 id="longitude"></h2>
        </h1>
    </div>
    <div id="map"></div>

    <!-- functions -->
    <script>

        // create your map
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: {lat: 37.5665, lng:126.9780},
            }
            );
            map.addListener("click", (e) => {
                create_marker_by_click(e.latLng,map);
            });

            // Init Autocomplete
            var input = document.getElementById('autocomplete');
            const options = {
                componentRestrictions: {'country':['US', 'AU', 'KR', 'SG']},
                fields: ['place_id','name','geometry','formatted_address']
            };
            const autocomplete = new google.maps.places.Autocomplete(input, options);
            // autocomplete connected to map viewport
            autocomplete.bindTo('bounds',map);

            // create marker for searched location, go to location, save into marker list
            autocomplete.addListener('place_changed', () => {

                const infowindow = new google.maps.InfoWindow();
                const icon = {
                    url:  "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    scaledSize: new google.maps.Size(30,30),
                    };
                const marker = new google.maps.Marker({
                    map: map,
                    icon: icon
                });
                
                infowindow.close()
                marker.setVisible(false);

                const place = autocomplete.getPlace();
                
                if (!place.geometry || !place.geometry.location) {
                window.alert(`No details available for the place: "${place.name}"`
                );
                return;
                }
                if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
                } else {
                map.setCenter(place.geometry.location);
                }

                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                marker.id = uniqueId;
                uniqueId++;
                
                const contentString = 
                `
                <div id="content">
                <div id="siteNotice"></div>

                <div class="container">
                
                <div class="row">
                    <div class = "col-8">
                    <span class="badge rounded-pill text-bg-warning">#Shopping</span>
                    <h3>${place.name}</h3>
                    <p class="address">${place.formatted_address}<p>
                    <hr>
                    <h6>$100/person</h6>
                    <p class="description">Description included by user.     Lorem, ipsum dolor sit amet consectetur adipisicing elit. Quod consequuntur, provident magnam nobis quis autem odit, nulla inventore cumque repudiandae facere. Nisi, itaque! Odit eos libero dolorem, reprehenderit dicta illo!</p>
                    </div>

                    <div class="col-4" style:"position:relative">
                    <p class="pt-3">Current Votes: </p>
                        <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" aria-label="voted_yes" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-danger" role="progressbar" aria-label="voted_no" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-secondary" role="progressbar" aria-label="yet_to_vote" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="voting_buttons pt-3">
                        <button type="button" class="btn btn-danger btn-sm reject_btn">Reject</button>
                        <button type="button" class="btn btn-success btn-sm vote_btn"> Vote </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm rounded bg-primary text-white float-end" data-bs-toggle="button">Edit</button>

                            <input type = 'button' va;ue = 'Delete' onclick = 'DeleteMarker( ${marker.id});' value = 'Delete Activity' />
                        </div>
                        
                    </div>

                </div>  
                </div>
            </div>
            </div>
                `
            infowindow.setContent(contentString);
            infowindow.open(map, marker);
            markers.push(marker)
            marker.addListener("click", (googleMapsEvent) => {
                infowindow.open(map, marker);})
            })
        }
        
        // create markers on click
        function create_marker_by_click(latLng, map) {
            
            const icon = {
               url:  "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
               scaledSize: new google.maps.Size(30,30),
            };
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: icon
            });

            // get location details from latLng NEED FIXING
            const geocoder = new google.maps.Geocoder();
            geocoder
                .geocode({ location: latLng })
                .then((response) => {
                if (response.results[0]) {
                    console.log(response.results[0])
                    
                } else {
                    window.alert("No results found");
                }
                })
                .catch((e) => window.alert("Geocoder failed due to: " + e));
            
            
            // identify the marker
            marker.id = uniqueId;
            uniqueId++;

            // customized InfoWindow
            const contentString = 
                `
                <div id="content">
                <div id="siteNotice"></div>

                <div class="container">
                
                <div class="row">
                    <div class = "col-8">
                    <span class="badge rounded-pill text-bg-warning">#Shopping</span>
                    <h3>Hongdae Shopping Street</h3>
                    <p class="address">365-8 Seogyo-dong, Mapo-gu, Seoul, South Korea<p>
                    <hr>
                    <h6>$100/person</h6>
                    <p class="description">Description included by user.     Lorem, ipsum dolor sit amet consectetur adipisicing elit. Quod consequuntur, provident magnam nobis quis autem odit, nulla inventore cumque repudiandae facere. Nisi, itaque! Odit eos libero dolorem, reprehenderit dicta illo!</p>
                    </div>

                    <div class="col-4" style:"position:relative">
                    <p class="pt-3">Current Votes: </p>
                        <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" aria-label="voted_yes" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-danger" role="progressbar" aria-label="voted_no" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                        <div class="progress-bar bg-secondary" role="progressbar" aria-label="yet_to_vote" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="voting_buttons pt-3">
                        <button type="button" class="btn btn-danger btn-sm reject_btn">Reject</button>
                        <button type="button" class="btn btn-success btn-sm vote_btn"> Vote </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm rounded bg-primary text-white float-end" data-bs-toggle="button">Edit</button>

                            <input type = 'button' va;ue = 'Delete' onclick = 'DeleteMarker( ${marker.id});' value = 'Delete Activity' />
                        </div>
                        
                    </div>

                </div>  
                </div>
            </div>
            </div>
                `

            const infoWindow = new google.maps.InfoWindow({
                content: contentString,
                disableAutoPan: true,
            });
            
            // allow marker to be deleted
            var label = "<br /><input type = 'button' va;ue = 'Delete' onclick = 'DeleteMarker(" + marker.id + ");' value = 'Delete' />";
            // open infoWindow :click
            marker.addListener("click", (googleMapsEvent) => {
                infoWindow.open(map, marker);
            });
            // add marker to array
            markers.push(marker)
        }

        // get place ID v1
        // function getPID(latLng) {
        //         var geocoder = new google.maps.Geocoder;
        //         if (latLng !== "") {
        //             return new Promise(function(resolve, reject) {
        //                 geocoder.geocode({'location': latLng}, function(results, status) {
        //                     if (status === google.maps.GeocoderStatus.OK) {
        //                         if (results[1]) {
        //                             // console.log(results[1].place_id);
        //                             resolve(results[1].place_id)
        //                         } else {
        //                             window.alert('No results found');
        //                         }
        //                         } else {
        //                         window.alert('Geocoder failed due to: ' + status);
        //                         }
        //                 });
        //             })
        //         }
        //     }

        // // get place ID v1
        // function get_place_id(marker,latLng) {
        //         var geocoder = new google.maps.Geocoder;

        //         latitude=marker.getPosition().lat();               
        //         longitude=marker.getPosition().lng();
        //         var latlng = {lat: parseFloat(latitude), lng: parseFloat(longitude)};
                
        //         geocoder.geocode({'location': latlng}, function(results, status) {
        //         if (status === google.maps.GeocoderStatus.OK) {
        //             if (results[1]) {
        //                 // console.log(results[1].place_id);
        //                 var p_id = results[1].place_id;
        //                 // console.log(p_id)
        //                 return p_id
        //             } else {
        //                 window.alert('No results found');
        //             }
        //         } else {
        //         window.alert('Geocoder failed due to: ' + status);
        //             }
        //         });
        //         }

        // get place details from place ID
        function get_place_details(p_id) {
            axios.get('https://maps.googleapis.com/maps/api/geocode/json', {
                    params: {
                        place_id:  p_id,
                        key: 'AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU'
                    }
                })
                    .then(response => {
                        console.log(response.data.results[0]);
                        var place_details = response.data.results[0]
                        return place_details
                    })
                    .catch( error => {
                        console.log(error.message);
                    });
        }

        // delete marker
        function DeleteMarker(id) {
                //Find and remove the marker from the Array
                for (var i = 0; i < markers.length; i++) {
                    if (markers[i].id == id) {
                        //Remove the marker from Map                  
                        markers[i].setMap(null);
        
                        //Remove the marker from array.
                        markers.splice(i, 1);
                        return;
                    }
                }
            };
            
        // delete all created markers
        function DeleteMarkers() {
            for (var i = 0; i < (markers.length)+1; i++) {
                //Remove the marker from Map                  
                markers[i].setMap(null);
            }
            markers = []
            uniqueId = 1
        }


        // cached variables
        var markers = [];
        var uniqueId = 1;

        window.initMap = initMap;
    </script>

    <!-- import scripts -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU&callback=initMap&libraries=places&v=weekly"
      defer
    ></script>
    <!-- <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw6a6E_r_udr7CXLmLZ-6HspypPd9qvMU&libraries=places&callback=initAutocomplete">
    </script> -->

</body>
</html>